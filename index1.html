<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AcademiChain Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --gradient: linear-gradient(135deg,#5e60ce 0%, #36cfc9 100%);
      --glass: rgba(44,54,100,0.36);
    }
    body {
      margin:0;
      font-family: 'Segoe UI',Arial,sans-serif;
      background: linear-gradient(135deg, #1a1837 0%, #321952 50%, #0e2c36 100%);
      color: #fff;
      min-height:100vh;
    }
    .glass {
      background: var(--glass);
      border-radius:22px;
      border: 1.5px solid #37fafa3b;
      backdrop-filter: blur(16px);
      box-shadow: 0 4px 24px 2px #23aaff36;
      padding: 24px;
    }
    .container { max-width: 840px; margin: 0 auto; padding: 32px 12px;}
    h1 { font-size:2.5rem; font-weight:bold; margin-bottom:14px;}
    .role-card { 
      display: inline-block; 
      vertical-align: top; 
      width: 260px; 
      height:200px; 
      cursor:pointer; 
      margin:12px; 
      border-radius:18px; 
      box-shadow:0 2px 20px #37fafa0c; 
      background: var(--glass);
      border:2px solid #2a3b50;
      transition:.15s;
      position:relative;
    }
    .role-card:hover { transform: scale(1.04); border-color: #36cfc9; box-shadow:0 2px 30px #5e60ce38;}
    .role-card h2 {margin-top:22px; font-size:1.18rem;}
    .role-card p {font-size:.97rem; color: #b4c5d6;}
    .button {
      background: var(--gradient);
      color:#fff; font-weight:bold; font-size:1rem;
      border-radius:12px; border:none;
      box-shadow:0 2px 10px #19e3cfae;
      margin-top:10px;
      padding:9px 22px;
      cursor:pointer;
      transition:.1s;
    }
    .button:hover {
      filter: brightness(1.18);
      box-shadow:0 2px 16px #37fafa9b;
      transform:scale(1.05);
    }
    .section-title {font-size:1.7rem; margin-top:10px;margin-bottom:16px; display:flex; align-items:center; gap:8px;}
    .input, .input-textarea {
      width:100%; padding:9px 12px; margin:6px 0;
      border-radius:8px;
      border:1.2px solid #36cfc9b4;
      background: #202f54b0; color:#fff;
      font-size:1rem;
    }
    .input-textarea {resize:vertical;}
    label { font-size:.97rem; }
    .credentials-list {margin-top:14px;}
    .cred-card {
      background: #233266b2; border-radius:12px; margin-top:8px; padding: 16px 12px; border:1px solid #22ececa6;
    }
    .timeline {margin-top:24px; margin-bottom:12px;}
    .timeline-event {
      background: var(--glass); 
      padding:10px 18px;
      border-radius:10px;
      border:1.2px solid #ae38f979;
      margin-bottom:8px;
      position:relative;
      left:30px
    }
    .timeline-event:before {
      content:"";
      width:16px;height:16px;
      background:var(--gradient);
      border-radius:50%;
      display:inline-block;
      margin-right:12px;
      position:absolute;
      left:-30px; top:50%; transform:translateY(-45%);
      box-shadow:0 0 15px #36cfc9;
    }
    .skill-graph { 
      width:330px; height:220px; background:#181b35a4; margin:24px auto 0 auto;
      border-radius:22px; 
      box-shadow: 0 2px 24px #ae38f958, 0 2px 24px #37fafa38;
      position:relative; 
      overflow:visible;
      padding:18px 0;
    }
    pre  { background: #202f54a7; padding: 10px; border-radius: 10px; font-size:.95rem; color:#d2f0fa;}
    .back-btn { background:#32e5df24; border-radius:8px; padding: 7px 19px; font-size:1.08rem; margin-top:10px; border:none; color:#48d3b8; cursor:pointer;}
    .back-btn:hover { background:#36cfc936; color:#fff;}
    .alert { color: #ffc528; margin-top:11px;}
    .status-success { color:#3df55d; font-weight:bold;}
    .status-error { color:#f364b2; font-weight:bold;}
    .fade { animation: fadein .6s;}
    @keyframes fadein { from {opacity:.2;} to {opacity:1;} }
  </style>
</head>
<body>
<div class="container" id="app"></div>

<script>
const app = document.getElementById('app');

// ========== UTILS ==========

function generateDID(address) {
  return `did:ethr:${address}`
}

function createCredential(issuerDID, studentDID, data) {
  const credential = {
    '@context': ['https://www.w3.org/2018/credentials/v1'],
    type: ['VerifiableCredential', 'AcademicCredential'],
    issuer: issuerDID,
    issuanceDate: new Date().toISOString(),
    credentialSubject: {
      id: studentDID,
      degree: data.degree,
      year: data.year,
      gpa: data.gpa,
      description: data.description,
      ipfsHash: data.ipfsHash
    },
    proof: {
      type: 'EcdsaSecp256k1Signature2019',
      created: new Date().toISOString(),
      proofPurpose: 'assertionMethod',
      verificationMethod: `${issuerDID}#keys-1`,
      jws: btoa(JSON.stringify({ issuer: issuerDID, subject: studentDID, timestamp: Date.now() }))
    }
  }
  return credential
}

function verifyCredential(vc) {
  try {
    if (!vc.proof || !vc.proof.jws) return { valid: false, reason: 'Missing proof' }
    const decoded = JSON.parse(atob(vc.proof.jws))
    const isValid = decoded.issuer === vc.issuer && decoded.subject === vc.credentialSubject.id
    return { valid: isValid, reason: isValid ? 'Valid signature' : 'Invalid signature' }
  } catch (e) {
    return { valid: false, reason: 'Verification failed' }
  }
}

function deriveCredential(originalVC, revealFields) {
  const derived = JSON.parse(JSON.stringify(originalVC))
  if (!revealFields.includes('gpa')) delete derived.credentialSubject.gpa
  if (!revealFields.includes('year')) delete derived.credentialSubject.year
  derived.proof.type = 'DerivedProof'
  return derived
}

async function uploadToIPFS(file) {
  return new Promise((resolve) => {
    setTimeout(() => {
      resolve('Qm' + Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15))
    }, 1400)
  })
}

// ========== UI ==========

// App State
let view = 'landing'
let universityDID = ''
let issuedCredential = null
let studentWallet = ''
let studentDID = ''
let studentCredentials = []
let employerResult = null

function render() {
  if (view === 'landing') renderLanding()
  if (view === 'university') renderUniversityPortal()
  if (view === 'student') renderStudentPortal()
  if (view === 'employer') renderEmployerPortal()
}

// -- Landing Page
function renderLanding() {
  app.innerHTML = `
    <h1 class="fade" style="text-align:center; margin-bottom:8px;">
      <span style="background:var(--gradient); -webkit-background-clip:text; background-clip:text; color:transparent;">AcademiChain</span>
    </h1>
    <p class="fade" style="text-align:center; font-size:1.21rem; color:#d7e3fb; margin-top:-8px;">
      Decentralized Academic Credential Verification System
      <br><span style="font-size:.97rem; color:#8dcfe6;">Powered by Blockchain & DID Technology</span>
    </p>
    <div style="text-align:center; margin-top:34px;">
      <div class="role-card" onclick="view='university'; universityDID=''; issuedCredential=null; render()">
        <h2>University Issuer</h2>
        <p>Issue verifiable credentials for students</p>
      </div>
      <div class="role-card" onclick="view='student'; studentWallet=''; studentDID=''; render()">
        <h2>Student</h2>
        <p>Manage your credentials wallet</p>
      </div>
      <div class="role-card" onclick="view='employer'; employerResult=null; render()">
        <h2>Employer Verifier</h2>
        <p>Verify credentials authenticity</p>
      </div>
    </div>
    <br><br>
    <div class="fade" style="text-align:center; font-size:.99rem; color:#aaa;">Glassmorphic Demo UI • JS only • No blockchain/IPFS</div>
  `
}

// -- University Portal
function renderUniversityPortal() {
  app.innerHTML = `
    <button class="back-btn" onclick="view='landing'; render()">← Back</button>
    <div class="glass">
      <div class="section-title">University Issuer Portal</div>
      <div>
        <b>Register DID:</b><br>
        ${universityDID ? `<div style="color:#3df55d;font-family:monospace;">${universityDID}</div>` :
        `<button class="button" onclick="registerUniversityDID()">Generate University DID</button>`}
      </div>
      <div style="margin-top:26px"><b>Issue Credential</b></div>
      <form id="issue-form" autocomplete="off">
        <input class="input" type="text" name="studentDID" placeholder="Student DID (did:ethr:0x...)" required />
        <input class="input" type="text" name="degree" placeholder="Degree Name" required />
        <input class="input" type="number" name="year" placeholder="Year" required />
        <input class="input" type="number" step="0.01" name="gpa" placeholder="GPA" required />
        <textarea class="input-textarea" name="description" placeholder="Description" rows="2" required></textarea>
        <label>Upload Certificate PDF (Optional)</label>
        <input class="input" type="file" name="pdf" accept=".pdf" />
        <button class="button" type="submit">Issue Credential</button>
      </form>
      <div id="uni-cred-result"></div>
    </div>
  `
  document.getElementById('issue-form').onsubmit = async function(e) {
    e.preventDefault()
    if (!universityDID) return alert('Register DID first!')
    let f = e.target
    let ipfsHash = ''
    if (f.pdf.files[0]) {
      ipfsHash = await uploadToIPFS(f.pdf.files[0])
    }
    issuedCredential = createCredential(
      universityDID, f.studentDID.value,
      { degree: f.degree.value, year: f.year.value, gpa: f.gpa.value, description: f.description.value, ipfsHash }
    )
    document.getElementById('uni-cred-result').innerHTML = `
      <div class="cred-card fade"><b>✓ Credential Issued</b>
      <pre>${JSON.stringify(issuedCredential,null,2)}</pre></div>
    `
  }
}

function registerUniversityDID() {
  universityDID = generateDID('0x' + Math.random().toString(16).substr(2, 40))
  renderUniversityPortal()
}

// -- Student Portal
function renderStudentPortal() {
  app.innerHTML = `
    <button class="back-btn" onclick="view='landing'; render()">← Back</button>
    <div class="glass">
      <div class="section-title">Student Portal</div>
      <div style="display:flex; gap:18px;">
        <div style="flex:1;">
          <div><b>Wallet Address:</b><br>
            ${
              studentWallet
                ? `<div style="font-family:monospace;background:#223c56ad;padding:5px;border-radius:10px;">${studentWallet}</div>
                   <button class="button" onclick="disconnectStudentWallet()" style="margin-top:7px;background:#f23674ab;">Disconnect</button>`
                : `<button class="button" id="walletConnectBtn">Connect Wallet</button>
                   <button class="button" onclick="generateStudentWallet()" style="margin-left:12px; background:#d243b941;">Mock Wallet</button>
                   <span id="walletConnectMsg" style="margin-left:10px;color:#ffe19f;"> </span>`
            }
          </div>
        </div>
        <div style="flex:1;">
          <div><b>DID:</b><br>
            ${studentDID ? `<div style="font-family:monospace;background:#223c56ad;padding:5px;border-radius:10px;">${studentDID}</div>`:
              `<button class="button" onclick="registerStudentDID()">Register DID</button>`}
          </div>
        </div>
      </div>
      <div style="margin:18px 0 0 0;">
        <button class="button" onclick="addDemoCredential()">+ Add Demo Credential</button>
      </div>
      <div class="credentials-list">
        ${studentCredentials.map((vc,i)=>`
          <div class="cred-card fade">
            <b>${vc.credentialSubject.degree}</b>
            <div>Year: ${vc.credentialSubject.year} | GPA: ${vc.credentialSubject.gpa}</div>
            <div>Description: ${vc.credentialSubject.description}</div>
            <button class="button" style="background:#e72e8eab;" onclick="selectRevealFields(${i})">Selective Reveal</button>
          </div>
        `).join('')}
        ${studentCredentials.length === 0 ? '<div class="alert">No credentials yet</div>' : ''}
      </div>
    </div>
    <div class="timeline">
      <div style="font-weight:bold;font-size:1.14rem; margin:15px 0 6px 22px;">Achievement Timeline</div>
      ${studentCredentials.map((vc,i)=>`
        <div class="timeline-event fade">
          <div><b>${vc.credentialSubject.degree}</b> [${vc.credentialSubject.year}]</div>
          <div>${vc.credentialSubject.description}</div>
          <div style="font-size:.92rem;color:#93fff2ad;">GPA: ${vc.credentialSubject.gpa}</div>
        </div>
      `).join('')}
      ${studentCredentials.length === 0 ? '<div class="alert">No achievements yet</div>' : ''}
    </div>
    <div class="skill-graph">
      ${renderSkillGraph(studentCredentials)}
    </div>
  `;

  // Wallet connect logic
  const connectBtn = document.getElementById('walletConnectBtn');
  if (connectBtn) {
    connectBtn.onclick = async function () {
      if (typeof window.ethereum === 'undefined') {
        document.getElementById('walletConnectMsg').textContent = "Install MetaMask or any Ethereum wallet extension!";
        return;
      }
      try {
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        studentWallet = accounts[0];
        renderStudentPortal();
      } catch (err) {
        document.getElementById('walletConnectMsg').textContent = "User denied wallet connection.";
      }
    }
  }
}

// New: disconnect wallet feature!
function disconnectStudentWallet() {
  studentWallet = '';
  studentDID = '';
  renderStudentPortal();
}

function generateStudentWallet() {
  studentWallet = '0x' + Math.random().toString(16).substr(2, 40)
  renderStudentPortal()
}

function registerStudentDID() {
  if (!studentWallet) { alert('Connect wallet first'); return }
  studentDID = generateDID(studentWallet)
  renderStudentPortal()
}

function addDemoCredential() {
  if (!studentDID) { alert('Register DID first!'); return }
  const mockVC = createCredential(
    'did:ethr:0xUniversity123', studentDID,
    { degree: 'Computer Science', year: '2024', gpa: '3.8', description: 'Bachelor of Science' }
  )
  studentCredentials.push(mockVC)
  localStorage.setItem('studentCredentials', JSON.stringify(studentCredentials))
  renderStudentPortal()
}

function selectRevealFields(idx) {
  const fields = ['degree','year','gpa','description']
  const vc = studentCredentials[idx]
  let reveal = []
  let modal = document.createElement('div')
  modal.innerHTML = `
    <div class="glass fade" style="max-width:490px;margin:40px auto 0 auto; z-index:10000; position:relative;">
      <b>Select fields to reveal for derived credential:</b>
      ${fields.map(f=>`<label><input type="checkbox" name="reveal-${f}" ${['degree'].includes(f)?'checked':''}/> ${f}</label>`).join('<br>')}
      <br><button class="button" id="do_reveal_btn">Generate Derived Credential</button>
      <button class="back-btn" id="close_reveal_btn">Cancel</button>
    </div>
  `
  document.body.appendChild(modal)
  document.getElementById('do_reveal_btn').onclick = function() {
    reveal = []
    fields.forEach(f=>{ if (modal.querySelector('input[name="reveal-'+f+'"]').checked) reveal.push(f)})
    const derived = deriveCredential(vc,reveal)
    alert('Derived Credential:\n' + JSON.stringify(derived,null,2))
    document.body.removeChild(modal)
  }
  document.getElementById('close_reveal_btn').onclick = function() {
    document.body.removeChild(modal)
  }
}

// -- Employer Portal
function renderEmployerPortal() {
  app.innerHTML = `
    <button class="back-btn" onclick="view='landing'; render()">← Back</button>
    <div class="glass">
      <div class="section-title">Employer Verifier Portal</div>
      <div><b>Paste VC JSON</b></div>
      <textarea class="input-textarea" id="employer-input" rows="7" placeholder="Paste Verifiable Credential JSON here..."></textarea>
      <button class="button" onclick="verifyEmployerCredential()">Verify Credential</button>
      <div id="employer-result"></div>
    </div>
  `
  if (employerResult) {
    document.getElementById('employer-result').innerHTML = `
      <div class="fade" style="margin-top:18px;">
        <div class="${employerResult.valid?'status-success':'status-error'}">
          ${employerResult.valid ? '✓ VALID' : '✗ INVALID'}
        </div>
        <div>Status: ${employerResult.status||'N/A'}</div>
        <div>Reason: ${employerResult.reason}</div>
        ${employerResult.credential?`<pre>${JSON.stringify(employerResult.credential,null,2)}</pre>`:''}
      </div>
    `
  }
}

function verifyEmployerCredential() {
  const input = document.getElementById('employer-input').value
  let result
  try {
    const vc = JSON.parse(input)
    const verification = verifyCredential(vc)
    const status = Math.random()>.2 ? 'ACTIVE' : 'REVOKED'
    result = {
      valid: verification.valid && status==='ACTIVE',
      reason: verification.valid ? (status==='ACTIVE'?'Credential is valid and active':'Credential has been revoked') : verification.reason,
      status, credential: vc
    }
  } catch (e) {
    result = { valid:false, reason:'Invalid JSON format'}
  }
  employerResult = result
  renderEmployerPortal()
}

// -- Skill Graph
function renderSkillGraph(credentials) {
  const skills = credentials.length ?
    [credentials[0].credentialSubject.degree,'Leadership','Research','Critical Thinking'] :
    ['Blockchain','React','Leadership','Critical']
  const cX=160, cY=100, r1=70, r2=38
  let nodes = skills.map((s,i)=>{
    const ang=(i/skills.length)*2*Math.PI
    const x=cX+r1*Math.cos(ang), y=cY+r1*Math.sin(ang)
    return {x,y,txt:s}
  })
  return `<svg width="320" height="180">
    ${nodes.map(n=>
      `<line x1="${cX}" y1="${cY}" x2="${n.x}" y2="${n.y}" stroke="#ae38f986" stroke-width="3"/>`
    ).join('')}
    ${nodes.map(n=>
      `<circle cx="${n.x}" cy="${n.y}" r="18" fill="#36cfc938" stroke="#ae38f986" stroke-width="2"/><text x="${n.x}" y="${n.y+4}" font-size="10" fill="#fff" text-anchor="middle">${n.txt.substring(0,8)}</text>`
    ).join('')}
    <circle cx="${cX}" cy="${cY}" r="${r2}" fill="#e72e8e6b" stroke="#ae38f986" stroke-width="3"/>
    <text x="${cX}" y="${cY+4}" font-size="11" fill="#fff" text-anchor="middle" font-weight="bold">YOU</text>
  </svg>`
}

// Restore credentials if possible
if (localStorage.getItem('studentCredentials')) {
  try { studentCredentials = JSON.parse(localStorage.getItem('studentCredentials')) || [] } catch {}
}
render()
</script>
</body>
</html>
